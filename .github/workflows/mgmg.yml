name: Force Sync with Details (Beijing Time)

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Git
      run: |
        git config --global user.name "Sync Bot"
        git config --global user.email "sync-bot@noreply.github.com"
        # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Always download and commit
      run: |
        # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•ï¼‰
        for i in {1..3}; do
          echo "ä¸‹è½½å°è¯• $i/3..."
          if curl -s -f -o interface.txt "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•..."
            sleep 5
          fi
        done
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        BEIJING_DATE=$(TZ="Asia/Shanghai" date '+%Yå¹´%mæœˆ%dæ—¥')
        BEIJING_TIME_12H=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %p %I:%M:%S')
        
        # åˆ›å»ºå¼ºåˆ¶æäº¤ä¿¡æ¯æ–‡ä»¶ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
        cat > sync-force.md << EOF
        # å¼ºåˆ¶åŒæ­¥è®°å½•
        
        æœ¬æ¬¡åŒæ­¥ä¿¡æ¯ï¼š
        - åŒ—äº¬æ—¶é—´: $BEIJING_TIME
        - æ—¥æœŸ: $BEIJING_DATE
        - 12å°æ—¶åˆ¶: $BEIJING_TIME_12H
        - è¿è¡ŒID: ${{ github.run_id }}
        - è§¦å‘æ–¹å¼: ${{ github.event_name }}
        - æºåœ°å€: https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt
        - åŒæ­¥é¢‘ç‡: æ¯30åˆ†é’Ÿ
        
        æ³¨æ„ï¼šæ­¤æ–‡ä»¶æ¯æ¬¡è¿è¡Œéƒ½ä¼šæ›´æ–°ï¼Œæ— è®ºæºæ–‡ä»¶æ˜¯å¦å˜åŒ–ã€‚
        
        ## æ—¶åŒºä¿¡æ¯
        - å½“å‰æ—¶åŒº: Asia/Shanghai (UTC+8)
        - ä¸‹æ¬¡åŒæ­¥: åŒ—äº¬æ—¶é—´ $(TZ="Asia/Shanghai" date -d '+30 minutes' '+%H:%M:%S')
        
        > æ–‡ä»¶è‡ªåŠ¨åŒæ­¥äº $BEIJING_TIME (åŒ—äº¬æ—¶é—´)
        EOF
        
        # æ·»åŠ æ–‡ä»¶å¹¶æäº¤
        git add -A
        
        # ä½¿ç”¨åŒ—äº¬æ—¶é—´çš„æäº¤ä¿¡æ¯
        COMMIT_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ğŸ”„ FORCE SYNC [$COMMIT_TIME åŒ—äº¬æ—¶é—´] #${{ github.run_number }}"
        
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€
        git push origin main
        
        echo "âœ… åŒæ­¥å®ŒæˆäºåŒ—äº¬æ—¶é—´: $BEIJING_TIME"

    - name: Show commit details
      run: |
        echo "=== åŒæ­¥æˆåŠŸ ==="
        echo "åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo "æäº¤å“ˆå¸Œ: $(git log -1 --pretty=format:'%H')"
        echo "æäº¤æ—¶é—´(UTC): $(git log -1 --pretty=format:'%cd')"
        echo "æäº¤æ—¶é—´(åŒ—äº¬æ—¶é—´): $(TZ="Asia/Shanghai" date -d "$(git log -1 --pretty=format:'%cd')" '+%Y-%m-%d %H:%M:%S')"
        echo "æäº¤ä¿¡æ¯: $(git log -1 --pretty=format:'%s')"
        echo "æ–‡ä»¶çŠ¶æ€:"
        git status --short
        echo ""
        echo "å½“å‰æ—¶é—´å¯¹ç…§:"
        echo "UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo "ä¸‹æ¬¡åŒæ­¥: åŒ—äº¬æ—¶é—´ $(TZ="Asia/Shanghai" date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S')"
