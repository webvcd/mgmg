name: æ¯30åˆ†é’Ÿå¼ºåˆ¶åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    # å¯¹åº”åŒ—äº¬æ—¶é—´ï¼š8:00, 8:30, 9:00, 9:30...ï¼ˆå…¨å¤©48æ¬¡ï¼‰
    - cron: '0,30 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_note:
        description: 'æ‰‹åŠ¨åŒæ­¥å¤‡æ³¨'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1ï¸âƒ£ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.SYNC_PAT }}  # ä½¿ç”¨PATè¿›è¡Œæ£€å‡ºå’Œæ¨é€

    - name: 2ï¸âƒ£ é…ç½®Git
      run: |
        git config --global user.name "GitHub Sync Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: 3ï¸âƒ£ è®¾ç½®æ—¶åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
      run: sudo timedatectl set-timezone Asia/Shanghai

    - name: 4ï¸âƒ£ ä¸‹è½½ç›®æ ‡æ–‡ä»¶
      run: |
        echo "ğŸ• å¼€å§‹ä¸‹è½½ï¼Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S') (UTC)"
        echo "ä¸‹è½½æºï¼šhttps://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"
        
        # ä½¿ç”¨wgetï¼ˆæ›´ç¨³å®šï¼‰
        if wget -q --show-progress --timeout=30 -O interface.txt "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"; then
          echo "âœ… ä¸‹è½½æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°ï¼š$(wc -l < interface.txt || echo 0) è¡Œ"
        else
          echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨curlé‡è¯•..."
          if curl -s -f -L -o interface.txt "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"; then
            echo "âœ… ä½¿ç”¨curlä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼éƒ½å¤±è´¥"
            # åˆ›å»ºç©ºæ–‡ä»¶é¿å…åç»­é”™è¯¯
            echo "# ä¸‹è½½å¤±è´¥äº $(date '+%Y-%m-%d %H:%M:%S') UTC" > interface.txt
          fi
        fi

    - name: 5ï¸âƒ£ åˆ›å»ºåŒæ­¥æ—¥å¿—
      run: |
        # åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        BEIJING_HOUR=$(TZ="Asia/Shanghai" date '+%H:%M')
        
        # ä¸‹æ¬¡åŒæ­¥æ—¶é—´
        NEXT_SYNC=$(TZ="Asia/Shanghai" date -d '+30 minutes' '+%H:%M')
        
        # åˆ›å»ºè¯¦ç»†çš„æ—¥å¿—æ–‡ä»¶
        cat > sync-log.md << EOF
        # ğŸ“¡ è‡ªåŠ¨åŒæ­¥æ—¥å¿—

        ## æœ¬æ¬¡åŒæ­¥ä¿¡æ¯
        - **åŒæ­¥æ—¶é—´**ï¼š$BEIJING_TIME (åŒ—äº¬æ—¶é—´)
        - **åŒæ­¥æ–¹å¼**ï¼š${{ github.event_name }}
        ${{ github.event.inputs.force_note && format('**æ‰‹åŠ¨å¤‡æ³¨**ï¼š{0}', github.event.inputs.force_note) || '' }}
        - **è¿è¡ŒID**ï¼š${{ github.run_id }}
        - **è¿è¡Œåºå·**ï¼š${{ github.run_number }}
        - **ä¸‹æ¬¡åŒæ­¥**ï¼šçº¦ $NEXT_SYNC (åŒ—äº¬æ—¶é—´)

        ## æ–‡ä»¶ä¿¡æ¯
        - **æºæ–‡ä»¶**ï¼š[interface.txt](https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt)
        - **åŒæ­¥é¢‘ç‡**ï¼šæ¯30åˆ†é’Ÿ
        - **æœ¬åœ°è·¯å¾„**ï¼šinterface.txt
        - **æ–‡ä»¶çŠ¶æ€**ï¼š$(if [ -f "interface.txt" ]; then echo "âœ… å·²ä¸‹è½½"; else echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"; fi)

        ## ç³»ç»Ÿä¿¡æ¯
        - **è¿è¡Œç³»ç»Ÿ**ï¼š${{ runner.os }}
        - **è§¦å‘äº‹ä»¶**ï¼š${{ github.event_name }}
        - **å·¥ä½œæµ**ï¼š${{ github.workflow }}
        - **ä»“åº“**ï¼š${{ github.repository }}

        > æœ€åæ›´æ–°ï¼š$BEIJING_TIME (åŒ—äº¬æ—¶é—´)
        > 
        > è‡ªåŠ¨åŒ–åŒæ­¥ | é¢‘ç‡ï¼šæ¯30åˆ†é’Ÿ | æ—¶åŒºï¼šAsia/Shanghai (UTC+8)
        EOF

        # ä¹Ÿåˆ›å»ºä¸€ä¸ªç®€å•çš„çŠ¶æ€æ–‡ä»¶
        echo "last_sync: $BEIJING_TIME" > sync-status.txt
        echo "next_sync: $NEXT_SYNC" >> sync-status.txt
        echo "run_id: ${{ github.run_id }}" >> sync-status.txt

    - name: 6ï¸âƒ£ æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        git add -A
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "å˜åŒ–çš„æ–‡ä»¶ï¼š"
          git diff --cached --name-only
        fi

    - name: 7ï¸âƒ£ æäº¤å¹¶æ¨é€ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # åŒ—äº¬æ—¶é—´
        COMMIT_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        COMMIT_HOUR=$(TZ="Asia/Shanghai" date '+%H:%M')
        
        # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®æäº¤ä¿¡æ¯
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          COMMIT_MSG="ğŸ”„ æ‰‹åŠ¨åŒæ­¥ [$COMMIT_HOUR åŒ—äº¬æ—¶é—´]"
          if [ -n "${{ github.event.inputs.force_note }}" ]; then
            COMMIT_MSG="$COMMIT_MSG - ${{ github.event.inputs.force_note }}"
          fi
        else
          COMMIT_MSG="â° è‡ªåŠ¨åŒæ­¥ [$COMMIT_HOUR åŒ—äº¬æ—¶é—´] #${{ github.run_number }}"
        fi
        
        echo "æäº¤ä¿¡æ¯ï¼š$COMMIT_MSG"
        
        git commit -m "$COMMIT_MSG"
        git push origin HEAD:main
        
        echo "âœ… æäº¤æˆåŠŸï¼"

    - name: 8ï¸âƒ£ æ— å˜åŒ–æ—¶çš„å¤„ç†
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        BEIJING_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        echo "å½“å‰æ—¶é—´ï¼š$BEIJING_TIME (åŒ—äº¬æ—¶é—´)"
        echo "ä¸‹æ¬¡åŒæ­¥ï¼š$(TZ="Asia/Shanghai" date -d '+30 minutes' '+%H:%M')"

    - name: 9ï¸âƒ£ æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
      run: |
        echo "========================================"
        echo "           åŒæ­¥ä»»åŠ¡å®ŒæˆæŠ¥å‘Š"
        echo "========================================"
        echo ""
        echo "ğŸ“… æ—¶é—´ä¿¡æ¯ï¼š"
        echo "  UTCæ—¶é—´ï¼š$(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "  åŒ—äº¬æ—¶é—´ï¼š$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "ğŸ“Š åŒæ­¥çŠ¶æ€ï¼š"
        if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
          echo "  âœ… æ£€æµ‹åˆ°å˜åŒ–å¹¶å·²æäº¤"
          echo "  æäº¤å“ˆå¸Œï¼š$(git log -1 --pretty=format:'%H')"
          echo "  æäº¤ä¿¡æ¯ï¼š$(git log -1 --pretty=format:'%s')"
        else
          echo "  â­ï¸  æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
        echo ""
        echo "ğŸ”® ä¸‹æ¬¡åŒæ­¥ï¼š"
        echo "  åŒ—äº¬æ—¶é—´ï¼š$(TZ="Asia/Shanghai" date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S')"
        echo "  ï¼ˆçº¦30åˆ†é’Ÿåï¼‰"
        echo ""
        echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la | grep -E "(interface|sync|log|status)"
        echo "========================================"