name: Force Sync with Details (Beijing Time)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Git
      run: |
        git config --global user.name "Sync Bot"
        git config --global user.email "sync-bot@noreply.github.com"

    - name: Always download and commit
      run: |
        # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•ï¼‰
        for i in {1..3}; do
          echo "ä¸‹è½½å°è¯• $i/3..."
          if curl -s -f -o interface.txt "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…åŽé‡è¯•..."
            sleep 5
          fi
        done
        
        # èŽ·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        
        # åˆ›å»ºå¼ºåˆ¶æäº¤ä¿¡æ¯æ–‡ä»¶
        cat > sync-force.md << EOF
        # å¼ºåˆ¶åŒæ­¥è®°å½•
        
        æœ¬æ¬¡åŒæ­¥ä¿¡æ¯ï¼š
        - åŒ—äº¬æ—¶é—´: $BEIJING_TIME
        - è¿è¡ŒID: ${{ github.run_id }}
        - è§¦å‘æ–¹å¼: ${{ github.event_name }}
        - æºåœ°å€: https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt
        
        æ³¨æ„ï¼šæ­¤æ–‡ä»¶æ¯æ¬¡è¿è¡Œéƒ½ä¼šæ›´æ–°ï¼Œæ— è®ºæºæ–‡ä»¶æ˜¯å¦å˜åŒ–ã€‚
        EOF
        
        # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add -A
        
        # å¼ºåˆ¶æäº¤ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
        git commit -m "ðŸ” FORCE SYNC [åŒ—äº¬æ—¶é—´ $BEIJING_TIME] #${{ github.run_number }}"
        
        # æŽ¨é€
        git push origin main

    - name: Show commit details
      run: |
        echo "=== åŒæ­¥æˆåŠŸ ==="
        echo "å½“å‰åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo "æäº¤å“ˆå¸Œ: $(git log -1 --pretty=format:'%H')"
        echo "æäº¤ä¿¡æ¯: $(git log -1 --pretty=format:'%s')"
        echo "æ–‡ä»¶çŠ¶æ€:"
        git status --short