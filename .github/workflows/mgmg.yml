name: æ¯30åˆ†é’Ÿå¼ºåˆ¶åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0,30 * * * *'
  workflow_dispatch:
    inputs:
      force_note:
        description: 'æ‰‹åŠ¨åŒæ­¥å¤‡æ³¨'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1ï¸âƒ£ æ£€å‡ºä»“åº“ï¼ˆä½¿ç”¨å®Œæ•´æƒé™ï¼‰
      uses: actions/checkout@v4
      with:
        # å¦‚æœé…ç½®äº†SYNC_PATï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤token
        token: ${{ secrets.SYNC_PAT || secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•

    - name: 2ï¸âƒ£ é…ç½®Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global pull.rebase false

    - name: 3ï¸âƒ£ è®¾ç½®æ—¶åŒº
      run: sudo timedatectl set-timezone Asia/Shanghai

    - name: 4ï¸âƒ£ å¼ºåˆ¶ä¸‹è½½æ–‡ä»¶
      id: download
      run: |
        echo "ğŸ• å¼€å§‹ä¸‹è½½ï¼Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S') (UTC)"
        
        # ä¸‹è½½æ–‡ä»¶ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
        for i in {1..3}; do
          echo "ä¸‹è½½å°è¯• $i/3..."
          if curl -s -f -L -o interface.txt "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            DOWNLOAD_SUCCESS=true
            break
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
            sleep 5
          fi
        done
        
        # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯æ–‡ä»¶
        if [ ! "$DOWNLOAD_SUCCESS" = true ]; then
          echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯æ–‡ä»¶"
          echo "# ä¸‹è½½å¤±è´¥äº $(date '+%Y-%m-%d %H:%M:%S') UTC" > interface.txt
          echo "# æºåœ°å€: https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt" >> interface.txt
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“„ æ–‡ä»¶ä¿¡æ¯ï¼š"
        ls -lh interface.txt
        echo "è¡Œæ•°ï¼š$(wc -l < interface.txt || echo 0)"

    - name: 5ï¸âƒ£ åˆ›å»ºåŒæ­¥çŠ¶æ€æ–‡ä»¶
      run: |
        # åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        BEIJING_DATE=$(TZ="Asia/Shanghai" date '+%Yå¹´%mæœˆ%dæ—¥')
        
        # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
        cat > SYNC_STATUS.md << 'EOF'
        # ğŸ”„ è‡ªåŠ¨åŒæ­¥çŠ¶æ€
        
        ## å½“å‰çŠ¶æ€
        - **æœ€ååŒæ­¥**: {{BEIJING_TIME}} (åŒ—äº¬æ—¶é—´)
        - **åŒæ­¥æ—¥æœŸ**: {{BEIJING_DATE}}
        - **è¿è¡ŒID**: {{RUN_ID}}
        - **è¿è¡Œæ¬¡æ•°**: {{RUN_NUMBER}}
        - **è§¦å‘æ–¹å¼**: {{TRIGGER_TYPE}}
        - **åŒæ­¥é¢‘ç‡**: æ¯30åˆ†é’Ÿ
        
        ## æ–‡ä»¶ä¿¡æ¯
        - **æºæ–‡ä»¶**: [interface.txt](https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt)
        - **æœ¬åœ°æ–‡ä»¶**: interface.txt
        - **æ–‡ä»¶å¤§å°**: {{FILE_SIZE}} å­—èŠ‚
        - **æ–‡ä»¶è¡Œæ•°**: {{FILE_LINES}} è¡Œ
        
        ## ä¸‹æ¬¡åŒæ­¥
        - **é¢„è®¡æ—¶é—´**: {{NEXT_SYNC}} (åŒ—äº¬æ—¶é—´)
        - **å‰©ä½™æ—¶é—´**: çº¦30åˆ†é’Ÿ
        
        > è‡ªåŠ¨åŒæ­¥ç³»ç»Ÿ | æ¯30åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ | æ—¶åŒº: åŒ—äº¬æ—¶é—´ (UTC+8)
        EOF
        
        # å¡«å……å˜é‡
        FILE_SIZE=$(wc -c < interface.txt 2>/dev/null || echo 0)
        FILE_LINES=$(wc -l < interface.txt 2>/dev/null || echo 0)
        NEXT_SYNC=$(TZ="Asia/Shanghai" date -d '+30 minutes' '+%H:%M:%S')
        
        # æ›¿æ¢å˜é‡
        sed -i "s/{{BEIJING_TIME}}/$BEIJING_TIME/g" SYNC_STATUS.md
        sed -i "s/{{BEIJING_DATE}}/$BEIJING_DATE/g" SYNC_STATUS.md
        sed -i "s/{{RUN_ID}}/${{ github.run_id }}/g" SYNC_STATUS.md
        sed -i "s/{{RUN_NUMBER}}/${{ github.run_number }}/g" SYNC_STATUS.md
        sed -i "s/{{TRIGGER_TYPE}}/${{ github.event_name }}/g" SYNC_STATUS.md
        sed -i "s/{{FILE_SIZE}}/$FILE_SIZE/g" SYNC_STATUS.md
        sed -i "s/{{FILE_LINES}}/$FILE_LINES/g" SYNC_STATUS.md
        sed -i "s/{{NEXT_SYNC}}/$NEXT_SYNC/g" SYNC_STATUS.md
        
        # åˆ›å»ºæ—¶é—´æˆ³æ–‡ä»¶
        echo "sync_time: $BEIJING_TIME" > sync_info.txt
        echo "run_id: ${{ github.run_id }}" >> sync_info.txt
        echo "run_number: ${{ github.run_number }}" >> sync_info.txt
        echo "trigger: ${{ github.event_name }}" >> sync_info.txt
        echo "next_sync: $NEXT_SYNC" >> sync_info.txt

    - name: 6ï¸âƒ£ å¼ºåˆ¶æäº¤æ›´æ”¹
      run: |
        # åŒ—äº¬æ—¶é—´
        COMMIT_TIME=$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')
        
        # æ£€æŸ¥å½“å‰çŠ¶æ€
        echo "å½“å‰åˆ†æ”¯ï¼š$(git branch --show-current)"
        echo "è¿œç¨‹ä»“åº“ï¼š$(git remote -v)"
        
        # æ‹‰å–æœ€æ–°æ›´æ”¹ï¼ˆé¿å…å†²çªï¼‰
        git pull origin main --no-rebase || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œåˆ›å»ºç©ºæäº¤"
          # åˆ›å»ºç©ºæ–‡ä»¶ä»¥ç¡®ä¿æœ‰å˜åŒ–
          echo "# å¼ºåˆ¶åŒæ­¥äº $COMMIT_TIME (åŒ—äº¬æ—¶é—´)" > force_sync_marker.txt
          git add force_sync_marker.txt
        fi
        
        # è®¾ç½®æäº¤ä¿¡æ¯
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          COMMIT_MSG="ğŸ”„ æ‰‹åŠ¨åŒæ­¥ [$COMMIT_TIME åŒ—äº¬æ—¶é—´] #${{ github.run_number }}"
          if [ -n "${{ github.event.inputs.force_note }}" ]; then
            COMMIT_MSG="$COMMIT_MSG - ${{ github.event.inputs.force_note }}"
          fi
        else
          # è®¡åˆ’ä»»åŠ¡
          MINUTE=$(TZ="Asia/Shanghai" date '+%M')
          if [ "$MINUTE" = "00" ]; then
            TIME_EMOJI="ğŸ•›"
          elif [ "$MINUTE" = "30" ]; then
            TIME_EMOJI="ğŸ•§"
          else
            TIME_EMOJI="â°"
          fi
          COMMIT_MSG="$TIME_EMOJI è‡ªåŠ¨åŒæ­¥ [$COMMIT_TIME åŒ—äº¬æ—¶é—´] #${{ github.run_number }}"
        fi
        
        echo "æäº¤ä¿¡æ¯ï¼š$COMMIT_MSG"
        
        # æäº¤æ›´æ”¹
        git commit -m "$COMMIT_MSG" --allow-empty
        
        # æ¨é€åˆ°ä»“åº“
        git push origin HEAD:main
        
        echo "âœ… æäº¤æˆåŠŸï¼"

    - name: 7ï¸âƒ£ éªŒè¯å’ŒæŠ¥å‘Š
      run: |
        echo "========================================"
        echo "         åŒæ­¥ä»»åŠ¡å®ŒæˆéªŒè¯"
        echo "========================================"
        
        # æ˜¾ç¤ºæœ€åæäº¤
        echo "ğŸ“ æœ€åæäº¤ä¿¡æ¯ï¼š"
        git log -1 --oneline
        
        echo ""
        echo "â° æ—¶é—´ä¿¡æ¯ï¼š"
        echo "  åŒ—äº¬æ—¶é—´ï¼š$(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la *.txt *.md 2>/dev/null || echo "æ— æ–‡ä»¶"
        
        echo ""
        echo "ğŸ”— GitHubé“¾æ¥ï¼š"
        echo "  ä»“åº“ï¼šhttps://github.com/${{ github.repository }}"
        echo "  æäº¤ï¼šhttps://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD)"
        
        echo "========================================"
